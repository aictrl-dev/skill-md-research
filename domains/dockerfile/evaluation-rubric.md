# Dockerfile Evaluation Rubric

## Overview

This rubric defines 14 rules for evaluating Dockerfiles generated by LLMs. 13 rules are automatable; rule 14 requires manual review. The evaluator (`evaluate_dockerfile.py`) checks each rule and outputs a CSV row per run.

## Extraction Logic

The evaluator extracts a Dockerfile from raw LLM output using the following strategy (in order):

1. **JSONL (opencode)**: Parse newline-delimited JSON events, extract `text` parts
2. **Claude CLI JSON**: Parse as JSON, extract `result` field
3. **Fenced code blocks**: Match `` ```dockerfile ``, `` ```Dockerfile ``, or `` ``` `` blocks containing `FROM`
4. **Header pattern**: Look for "Dockerfile:" header followed by content with `FROM`
5. **Plain text**: Match content starting with `FROM` instruction

Extraction succeeds if the candidate contains at least one `FROM` instruction. If no Dockerfile is found, all rules score 0.

## Structure Validation

Before rule checks, the evaluator validates basic structure:
- Must contain at least one `FROM` instruction
- Must contain at least one `CMD` or `ENTRYPOINT` instruction

If structure validation fails, individual rule checks still run but results may be unreliable.

## Rule Table

| # | Category | Rule | Auto | Pass Criteria | Fail Example | Pass Example |
|---|----------|------|------|---------------|--------------|--------------|
| 1 | BASE | Specific image tag | YES | Every `FROM` has a version tag that is not `:latest` | `FROM node:latest` or `FROM ubuntu` | `FROM node:20-alpine` |
| 2 | SECURITY | Non-root USER | YES | `USER` instruction with non-root user present | No `USER` instruction, or `USER root` | `USER appuser` |
| 3 | SECURITY | No secrets in ENV/ARG | SEMI | No `ENV`/`ARG` with secret-like names AND hardcoded values | `ARG API_KEY=sk-abc123` | `ARG API_KEY` (no default) or no secret-like names |
| 4 | STRUCTURE | Multi-stage build | YES | At least 2 `FROM` statements | Single `FROM node:20-alpine` | `FROM node:20-alpine AS builder` ... `FROM node:20-alpine` |
| 5 | STRUCTURE | WORKDIR before COPY/RUN | YES | `WORKDIR` appears before first `COPY` or `RUN` in each stage | `FROM node:20-alpine` then `COPY . .` (no WORKDIR) | `FROM node:20-alpine` then `WORKDIR /app` then `COPY . .` |
| 6 | CACHE | Deps before source | SEMI | Dependency manifest files (package.json, requirements.txt, go.mod) `COPY`'d before broad `COPY . .` | `COPY . .` then `RUN npm install` | `COPY package*.json ./` then `RUN npm ci` then `COPY . .` |
| 7 | LAYERS | Combined RUN | SEMI | No more than 2 adjacent `RUN` instructions (per stage) | 3+ consecutive `RUN` lines | `RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*` |
| 8 | APT | apt best practices | YES | `apt-get install` includes `--no-install-recommends` AND `rm -rf /var/lib/apt/lists/*` in same `RUN` | `RUN apt-get install -y curl` | `RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*` |
| 9 | HEALTH | HEALTHCHECK present | YES | `HEALTHCHECK` instruction exists | No HEALTHCHECK | `HEALTHCHECK CMD curl -f http://localhost:3000/health \|\| exit 1` |
| 10 | DOCS | EXPOSE documented | YES | At least one `EXPOSE` instruction | No EXPOSE | `EXPOSE 3000` |
| 11 | DOCS | LABEL metadata | YES | At least one `LABEL` instruction | No LABEL | `LABEL maintainer="team@example.com"` |
| 12 | ENTRY | Exec form CMD/ENTRYPOINT | SEMI | `CMD` and `ENTRYPOINT` args start with `[` (JSON array) | `CMD node server.js` | `CMD ["node", "server.js"]` |
| 13 | COPY | No unnecessary ADD | YES | No `ADD` unless extracting tar or fetching URL | `ADD . .` | `COPY . .` |
| 14 | IGNORE | .dockerignore considered | MANUAL | Cannot verify from Dockerfile; always returns `True` with `needs_review` | N/A | N/A |

### Automation Levels

- **YES**: Fully automatable, deterministic regex check
- **SEMI**: Best-effort heuristic, may produce false positives/negatives
- **MANUAL**: Cannot be automated from Dockerfile text alone

## Edge Cases

### Multi-Stage Builds (Rule 4)

- The `scratch` base image counts as a `FROM` but does not need a version tag (Rule 1 exemption)
- `COPY --from=builder` does not require WORKDIR to precede it (Rule 5 exemption)
- Each stage resets the WORKDIR check and RUN adjacency counter

### Multi-Target Builds (Task 3)

- A multi-target Dockerfile has multiple final stages (e.g., `FROM ... AS frontend`, `FROM ... AS api`, `FROM ... AS worker`)
- Rule 4 (multi-stage) is automatically satisfied since multi-target implies multiple FROM
- Each target is evaluated as part of the same Dockerfile; all rules apply globally
- Rule 1 (tags) must pass for ALL FROM instructions across all targets

### APT Rules (Rule 8)

- Only applies if `apt-get install` is present in a RUN instruction
- If no apt-get install exists (e.g., Alpine-only Dockerfile using apk), rule 8 returns `n/a` (pass)
- The `--no-install-recommends` flag and `rm -rf /var/lib/apt/lists/*` must be in the same RUN instruction (not separate RUN lines)

### Secret Detection (Rule 3)

- Only flags secrets when both a secret-like variable name AND a hardcoded value (`=`) are present
- `ARG API_KEY` (no default value) does NOT fail â€” it is a build-time parameter set externally
- `ENV DATABASE_URL=postgres://...` with a real connection string would fail if it contains "password" in the URL

### Exec Form Detection (Rule 12)

- Checks if `CMD`/`ENTRYPOINT` arguments start with `[` character
- `CMD ["node", "server.js"]` passes (exec form)
- `CMD node server.js` fails (shell form)
- If no CMD or ENTRYPOINT is found, rule returns pass with `needs_review`

### Dependency Detection (Rule 6)

- Recognized dependency files: `package.json`, `package-lock.json`, `yarn.lock`, `requirements.txt`, `Pipfile`, `pyproject.toml`, `go.mod`, `go.sum`, `Cargo.toml`, `Cargo.lock`, `pom.xml`, `build.gradle`
- A "broad copy" is detected by patterns like `COPY . .`, `COPY . /app`, etc.
- If no broad copy is detected, rule returns pass with `needs_review`

## Expected Outputs Per Task

### Task 1: Node.js Express (simple)

Expected rule results for a well-written Dockerfile:

| Rule | Expected | Notes |
|------|----------|-------|
| 1 (tag) | PASS | `FROM node:20-alpine` |
| 2 (user) | PASS | `USER node` or custom user |
| 3 (secrets) | PASS | No secrets expected |
| 4 (multistage) | PASS | Build stage + production stage |
| 5 (workdir) | PASS | `WORKDIR /app` |
| 6 (deps first) | PASS | `COPY package*.json ./` before `COPY . .` |
| 7 (combined run) | PASS | Few RUN instructions, easily combined |
| 8 (apt) | N/A | Alpine uses apk, not apt |
| 9 (healthcheck) | PASS | `HEALTHCHECK CMD wget ... /health` |
| 10 (expose) | PASS | `EXPOSE 3000` |
| 11 (label) | PASS | At least one LABEL |
| 12 (exec form) | PASS | `CMD ["node", "dist/server.js"]` |
| 13 (no add) | PASS | Only COPY used |
| 14 (dockerignore) | REVIEW | Manual check |

### Task 2: Python ML (medium)

| Rule | Expected | Notes |
|------|----------|-------|
| 1 (tag) | PASS | `FROM python:3.11-slim` |
| 2 (user) | PASS | Custom appuser |
| 3 (secrets) | PASS | No secrets expected |
| 4 (multistage) | PASS | Builder + runtime stages |
| 5 (workdir) | PASS | `WORKDIR /app` in each stage |
| 6 (deps first) | PASS | `COPY requirements.txt` before `COPY . .` |
| 7 (combined run) | PASS | apt + pip installs combined |
| 8 (apt) | PASS | `--no-install-recommends` + cleanup for libgl1 etc. |
| 9 (healthcheck) | PASS | Health check on /health:8000 |
| 10 (expose) | PASS | `EXPOSE 8000` |
| 11 (label) | PASS | At least one LABEL |
| 12 (exec form) | PASS | `CMD ["uvicorn", "main:app", ...]` |
| 13 (no add) | PASS | Only COPY used |
| 14 (dockerignore) | REVIEW | Manual check |

### Task 3: Monorepo Multi-Target (complex)

| Rule | Expected | Notes |
|------|----------|-------|
| 1 (tag) | PASS | All FROM images tagged: node, golang, python, nginx |
| 2 (user) | PASS | Non-root user in each final target |
| 3 (secrets) | PASS | No secrets expected |
| 4 (multistage) | PASS | Many stages (builders + 3 targets) |
| 5 (workdir) | PASS | WORKDIR set in each stage |
| 6 (deps first) | PASS | Dep files for each language copied first |
| 7 (combined run) | PASS | RUN instructions combined per stage |
| 8 (apt) | VARIES | May or may not use apt (depends on base images) |
| 9 (healthcheck) | PASS | HEALTHCHECK in api and frontend targets |
| 10 (expose) | PASS | EXPOSE 80, 8080 in respective targets |
| 11 (label) | PASS | At least one LABEL |
| 12 (exec form) | PASS | All CMD/ENTRYPOINT in exec form |
| 13 (no add) | PASS | Only COPY used |
| 14 (dockerignore) | REVIEW | Manual check |

## Scoring

- **auto_score**: Count of rules that pass (0-14). Rule 14 always contributes 1 point since it returns True.
- **needs_manual_review**: True if any rule detail contains "needs_review" (rules 6, 12, 14 may trigger this).
- Maximum automatable score: 14 (including rule 14's automatic pass).
- Effective automatable rules: 13 (rule 14 is always pass).

## CSV Output Format

Each row in `scores.csv` represents one evaluation run with columns:

```
run_id, model, condition, task, task_complexity, rep, duration_ms,
extraction_ok, extraction_error, structure_valid, structure_errors,
rule_1_tag_pass, rule_1_tag_detail,
rule_2_user_pass, rule_2_user_detail,
...
rule_14_dockerignore_pass, rule_14_dockerignore_detail,
auto_score, needs_manual_review
```

Boolean columns use Python's `True`/`False` in CSV output.
