# OpenAPI Spec Evaluation Rubric

## Overview

This rubric defines 14 rules for evaluating OpenAPI 3.0 specifications generated by LLMs. All rules are fully automated. The rule set combines 5 universal API design rules (~100% baseline) with 9 opinionated enterprise standards (~0-20% baseline each).

Expected baseline without skill: 40-55%. Expected with skill: 80-93%.

## Extraction Logic

The evaluator extracts an OpenAPI spec from raw model output in this order:

1. **JSONL event stream** — Detect opencode-format JSONL and extract text parts
2. **Claude CLI wrapper** — Parse outer JSON and extract `result` field
3. **Permission denials** — Check Write tool permission denials (Haiku fallback)
4. **Fenced code blocks** — Try `json`, `yaml`, `yml`, and bare `` ``` `` fences
5. **Direct JSON parse** — Attempt `json.loads()` on full text
6. **Direct YAML parse** — Attempt `yaml.safe_load()` on full text (requires PyYAML)
7. **Brace matching** — Find first `{ ... }` block and parse as JSON

## Rule Reference Table

| # | Category | Rule | Baseline Est. | Pass | Fail |
|---|----------|------|---------------|------|------|
| 1 | UNIVERSAL | Plural nouns for collections | ~100% | `/users` | `/user` |
| 2 | UNIVERSAL | Kebab-case paths | ~100% | `/user-profiles` | `/userProfiles` |
| 3 | UNIVERSAL | No verbs in paths | ~100% | `GET /users` | `GET /getUsers` |
| 4 | UNIVERSAL | operationId on all ops | ~100% | All ops have operationId | Any op missing it |
| 5 | UNIVERSAL | Summary/description on ops | ~100% | All ops documented | Any op undocumented |
| 6 | ENTERPRISE | camelCase properties | ~0% | `userId`, `createdAt` | `user_id`, `created_at` |
| 7 | ENTERPRISE | info.contact present | ~20% | `contact: {email: ...}` | No contact block |
| 8 | ENTERPRISE | RFC 7807 error schema | ~0% | ProblemDetail with type/title/status/detail | `{error: string}` |
| 9 | ENTERPRISE | Cursor pagination | ~5% | `{data: [], nextCursor, hasMore}` | Bare array or offset pagination |
| 10 | ENTERPRISE | Rate-limit headers | ~0% | X-RateLimit-Limit/Remaining/Reset | No rate-limit headers |
| 11 | ENTERPRISE | Idempotency-Key header | ~0% | POST/PUT accept Idempotency-Key | No such header |
| 12 | ENTERPRISE | Example values | ~10% | All properties have `example` | Properties without examples |
| 13 | CONDITIONAL | Security scheme defined | ~80% | securitySchemes block | Missing (when auth required) |
| 14 | CONDITIONAL | Security applied | ~80% | Global or per-op security | Scheme unused |

## Detailed Rule Specifications

### Rule 1: Plural Nouns for Collections

Collection path segments must use plural nouns. Checked against a list of ~30 known singular forms (user, product, order, etc.). Path parameters ({userId}) and version prefixes (v1) are excluded.

### Rule 2: Kebab-case Paths

Path segments must be lowercase with hyphens only. No camelCase (`userProfiles`) or underscores (`user_profiles`).

### Rule 3: No Verbs in Paths

No blacklisted verbs (get, create, delete, update, fetch, remove, add, list, search, find, retrieve, modify, put, post, patch) as segments or camelCase prefixes.

### Rule 4: operationId

Every HTTP operation must have a non-empty `operationId`.

### Rule 5: Operation Documentation

Every operation must have at least a `description` or `summary` field.

### Rule 6: camelCase Properties

All schema property names must match `^[a-z][a-zA-Z0-9]*$`. Properties like `user_id`, `created_at`, `is_active` fail.

**Why models fail (~0%)**: Models default to snake_case for database-style fields.

### Rule 7: info.contact Present

`info.contact` must exist and have at least `email` or `url`.

**Why models fail (~20%)**: Most models skip the contact block.

### Rule 8: RFC 7807 Error Schema

Error responses (4xx, 5xx, or default) must reference a schema containing ALL of: `type`, `title`, `status`, `detail` properties. The check resolves `$ref` to `components.schemas` and inspects property names.

**Why models fail (~0%)**: Models use ad-hoc `{message: string}` or `{error: string}` schemas, never RFC 7807.

### Rule 9: Cursor Pagination

GET operations on collection endpoints must return a pagination envelope with `data` (array), `nextCursor` (string), and `hasMore` (boolean) properties. Only checked when `task.requires_pagination` is true.

**Why models fail (~5%)**: Models return bare arrays or use offset-based pagination (page/limit).

### Rule 10: Rate-Limit Headers

Every success response (2xx) must document all three headers: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`. Header names are matched case-insensitively. All success responses must be compliant, not just one.

**Why models fail (~0%)**: Models never add rate-limit headers unprompted.

### Rule 11: Idempotency-Key Header

At least one POST or PUT operation must accept an `Idempotency-Key` header parameter. Checks both operation-level and path-level parameters.

**Why models fail (~0%)**: Idempotency headers are an advanced enterprise pattern.

### Rule 12: Example Values

Schema properties must have `example` fields. Pass threshold: >= 80% of all properties across all schemas have examples.

**Why models fail (~10%)**: Models occasionally add examples but rarely to every property.

### Rule 13: Security Scheme Defined (Conditional)

Only checked when `task.requires_auth == true`. Must have `components.securitySchemes` with at least one scheme. Auto-pass when auth not required.

### Rule 14: Security Applied (Conditional)

Only checked when `task.requires_auth == true`. Security must be applied globally or per-operation. Empty `security: []` is rejected. Auto-pass when auth not required.

## Expected Outputs Per Task

### Task 1: User Management (Simple)

- **Paths**: `/users`, `/users/{userId}`
- **Auth**: Not required (rules 13-14 auto-pass)
- **Pagination**: Required (rule 9 checked)
- **Expected baseline**: ~7/14 (5 universal + contact sometimes + some partial)
- **Expected with skill**: ~12-13/14

### Task 2: E-commerce (Medium)

- **Paths**: `/users`, `/users/{userId}`, `/products`, `/orders`, `/orders/{orderId}`
- **Auth**: Bearer JWT (rules 13-14 checked)
- **Pagination**: Required
- **Expected baseline**: ~7/14
- **Expected with skill**: ~12-14/14

### Task 3: Payment Processing (Complex)

- **Paths**: `/v1/merchants`, `/v1/payments`, `/v1/payments/{paymentId}/refunds`, `/v1/webhooks`
- **Auth**: OAuth2 (rules 13-14 checked)
- **Pagination**: Required
- **Async**: 202 Accepted
- **Expected baseline**: ~7/14
- **Expected with skill**: ~11-13/14

## Outcome Checks (Semantic Correctness)

In addition to the 14 style rules, 3 outcome checks verify semantic completeness:

1. **outcome_paths_present**: All expected paths from the task exist
2. **outcome_schemas_present**: All expected schema names exist (case-insensitive)
3. **outcome_async_202**: 202 Accepted response on POST when task requires async

## CSV Output Columns

| Column | Type | Description |
|--------|------|-------------|
| run_id | string | Unique run identifier |
| model | string | Model name |
| condition | string | none / markdown / pseudocode |
| task | string | Task ID (1, 2, 3) |
| task_complexity | string | simple / medium / complex |
| rep | int | Repetition number |
| duration_ms | int | Generation time in ms |
| extraction_ok | bool | Spec successfully extracted |
| extraction_error | string | Error if extraction failed |
| structure_valid | bool | Has openapi, info, paths |
| structure_errors | string | Structure validation errors |
| rule_N_*_pass | bool | Whether rule N passed |
| rule_N_*_detail | string | Detail/reason for pass or fail |
| auto_score | int | Count of passing rules (0-14) |
| scored_rules | int | Number of scored rules (14) |
| needs_manual_review | bool | Always False |
| outcome_*_pass | bool | Outcome check result |
| outcome_*_detail | string | Outcome check detail |
| outcome_score | int | Count of passing outcome checks |
